# Makefile para projeto SIA2 - Docker
.PHONY: help setup validate start stop clean logs shell db-init db-clean mobile

# Comando padrÃ£o
help:
	@echo "ğŸš€ SIA2 - Sistema de AutomaÃ§Ã£o de Estufa"
	@echo ""
	@echo "Comandos disponÃ­veis:"
	@echo "  make setup      - ConfiguraÃ§Ã£o inicial completa"
	@echo "  make validate   - Validar configuraÃ§Ã£o"
	@echo "  make start      - Iniciar projeto (web + banco)"
	@echo "  make mobile     - Iniciar com app mÃ³vel"
	@echo "  make stop       - Parar todos os serviÃ§os"
	@echo "  make restart    - Parar e iniciar novamente"
	@echo "  make logs       - Ver logs em tempo real"
	@echo "  make shell      - Shell na aplicaÃ§Ã£o web"
	@echo "  make db-init    - Inicializar banco de dados"
	@echo "  make db-clean   - Limpar dados do banco"
	@echo "  make clean      - Limpeza completa"
	@echo "  make status     - Status dos containers"
	@echo ""
	@echo "ğŸ“¦ INSTALAÃ‡ÃƒO:"
	@echo "  install          - Instala dependÃªncias bÃ¡sicas"
	@echo "  install-dev      - Instala dependÃªncias de desenvolvimento"
	@echo ""
	@echo "ğŸ§ª TESTES:"
	@echo "  test             - Executa todos os testes"
	@echo "  test-unit        - Executa apenas testes unitÃ¡rios"
	@echo "  test-integration - Executa testes de integraÃ§Ã£o"
	@echo "  test-auth        - Executa testes de autenticaÃ§Ã£o"
	@echo "  test-admin       - Executa testes de rotas administrativas"
	@echo "  test-coverage    - Executa testes com cobertura detalhada"
	@echo "  test-fast        - Executa testes rÃ¡pidos (sem integraÃ§Ã£o)"
	@echo ""
	@echo "ğŸ” QUALIDADE:"
	@echo "  lint             - Executa verificaÃ§Ãµes de cÃ³digo"
	@echo "  format           - Formata cÃ³digo automaticamente"
	@echo "  security         - Executa verificaÃ§Ãµes de seguranÃ§a"
	@echo "  check-all        - Executa todas as verificaÃ§Ãµes"
	@echo ""
	@echo "ğŸƒ EXECUÃ‡ÃƒO:"
	@echo "  run-dev          - Executa servidor de desenvolvimento"
	@echo "  setup-db         - Configura banco de dados"
	@echo ""
	@echo "ğŸ§¹ LIMPEZA:"
	@echo "  clean            - Remove arquivos temporÃ¡rios"
	@echo "  clean-all        - Limpeza completa"

# Setup inicial
setup:
	@echo "ğŸ”§ Executando setup inicial..."
	@chmod +x setup.sh db-init.sh db-rm.sh validate.sh
	@./setup.sh

# ValidaÃ§Ã£o
validate:
	@echo "ğŸ” Validando configuraÃ§Ã£o..."
	@chmod +x validate.sh
	@./validate.sh

# Iniciar projeto
start:
	@echo "ğŸš€ Iniciando projeto SIA2..."
	@docker compose up -d
	@echo "âœ… Projeto iniciado!"
	@echo "ğŸŒ Acesse: http://localhost:5000"

# Iniciar com mÃ³vel
mobile:
	@echo "ğŸ“± Iniciando projeto com app mÃ³vel..."
	@docker compose --profile mobile up -d
	@echo "âœ… Projeto iniciado com app mÃ³vel!"
	@echo "ğŸŒ Web: http://localhost:5000"
	@echo "ğŸ“± Mobile: make mobile-run"

# Executar app mÃ³vel
mobile-run:
	@echo "ğŸ“± Executando app mÃ³vel..."
	@docker compose exec mobile python main_app.py

# Parar serviÃ§os
stop:
	@echo "ğŸ›‘ Parando serviÃ§os..."
	@docker compose down

# Reiniciar
restart: stop start

# Ver logs
logs:
	@echo "ğŸ“Š Logs em tempo real (Ctrl+C para sair)..."
	@docker compose logs -f

# Shell na aplicaÃ§Ã£o
shell:
	@echo "ğŸš Abrindo shell na aplicaÃ§Ã£o web..."
	@docker compose exec web bash

# Shell no banco
db-shell:
	@echo "ğŸ—„ï¸ Abrindo shell no PostgreSQL..."
	@docker compose exec postgres psql -U lopinhos -d siia

# Inicializar banco
db-init:
	@echo "ğŸ—„ï¸ Inicializando banco de dados..."
	@chmod +x db-init.sh
	@./db-init.sh

# Limpar banco
db-clean:
	@echo "ğŸ§¹ Limpando dados do banco..."
	@docker compose down -v
	@docker volume rm sia2_postgres_data 2>/dev/null || true

# Status
status:
	@echo "ğŸ“Š Status dos containers:"
	@docker compose ps
	@echo ""
	@echo "ğŸ’¾ Volumes:"
	@docker compose config --volumes

# Limpeza completa
clean:
	@echo "ğŸ§¹ Limpeza completa..."
	@chmod +x db-rm.sh
	@./db-rm.sh

# Rebuild
rebuild:
	@echo "ğŸ”¨ Reconstruindo imagens..."
	@docker compose build --no-cache

# Desenvolvimento
dev:
	@echo "ğŸ”§ Modo desenvolvimento..."
	@docker compose -f docker-compose.yml up -d

# Testes
test-web:
	@echo "ğŸ§ª Executando testes web..."
	@docker compose exec web python -m pytest

test-mobile:
	@echo "ğŸ“± Executando testes mÃ³vel..."
	@docker compose exec mobile python test_integration.py

# Backup banco
backup:
	@echo "ğŸ’¾ Fazendo backup do banco..."
	@mkdir -p backups
	@docker compose exec postgres pg_dump -U lopinhos siia > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup salvo em backups/"

# InstalaÃ§Ã£o
install:
	@echo "ğŸ“¦ Instalando dependÃªncias bÃ¡sicas..."
	$(PIP) install -r requirements.txt

install-dev:
	@echo "ğŸ“¦ Instalando dependÃªncias de desenvolvimento..."
	$(PIP) install -r requirements.txt
	$(PIP) install -r requirements-test.txt

# Testes
test:
	@echo "ğŸ§ª Executando todos os testes..."
	$(PYTEST) -v --tb=short

test-unit:
	@echo "ğŸ§ª Executando testes unitÃ¡rios..."
	$(PYTEST) tests/test_models.py -v -m unit

test-integration:
	@echo "ğŸ§ª Executando testes de integraÃ§Ã£o..."
	$(PYTEST) tests/test_integration.py -v -m integration

test-auth:
	@echo "ğŸ§ª Executando testes de autenticaÃ§Ã£o..."
	$(PYTEST) tests/test_auth.py -v -m auth

test-admin:
	@echo "ğŸ§ª Executando testes de rotas administrativas..."
	$(PYTEST) tests/test_admin_routes.py -v -m admin

test-coverage:
	@echo "ğŸ§ª Executando testes com cobertura..."
	$(PYTEST) --cov=. --cov-report=html --cov-report=term-missing --cov-fail-under=80
	@echo "ğŸ“Š RelatÃ³rio de cobertura gerado em htmlcov/index.html"

test-fast:
	@echo "ğŸ§ª Executando testes rÃ¡pidos..."
	$(PYTEST) -v -m "unit or auth" --tb=short

test-watch:
	@echo "ğŸ§ª Executando testes em modo watch..."
	$(PYTEST) -f

# Qualidade de cÃ³digo
lint:
	@echo "ğŸ” Verificando qualidade do cÃ³digo..."
	@echo "  â†’ Flake8..."
	$(FLAKE8) . --count --statistics --max-line-length=127
	@echo "  â†’ Black (check)..."
	$(BLACK) --check --diff .
	@echo "  â†’ Isort (check)..."
	$(ISORT) --check-only --diff .

format:
	@echo "ğŸ¨ Formatando cÃ³digo..."
	@echo "  â†’ Black..."
	$(BLACK) .
	@echo "  â†’ Isort..."
	$(ISORT) .
	@echo "âœ… CÃ³digo formatado!"

security:
	@echo "ğŸ”’ Verificando seguranÃ§a..."
	@echo "  â†’ Bandit..."
	$(BANDIT) -r . -f txt
	@echo "  â†’ Safety..."
	$(SAFETY) check

check-all: lint security
	@echo "âœ… Todas as verificaÃ§Ãµes concluÃ­das!"

# ExecuÃ§Ã£o
run-dev:
	@echo "ğŸƒ Iniciando servidor de desenvolvimento..."
	$(PYTHON) app.py

setup-db:
	@echo "ğŸ—„ï¸ Configurando banco de dados..."
	$(PYTHON) -c "from app import app, db; app.app_context().push(); db.create_all(); print('âœ… Banco de dados configurado!')"

# Limpeza
clean:
	@echo "ğŸ§¹ Removendo arquivos temporÃ¡rios..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache
	rm -rf htmlcov
	rm -rf .coverage
	rm -rf reports
	@echo "âœ… Limpeza concluÃ­da!"

clean-all: clean
	@echo "ğŸ§¹ Limpeza completa..."
	rm -rf dist
	rm -rf build
	rm -rf *.log
	@echo "âœ… Limpeza completa concluÃ­da!"

# ConfiguraÃ§Ãµes especiais
.SILENT: help

# Targets para CI/CD
ci-install:
	$(PIP) install -r requirements.txt
	$(PIP) install -r requirements-test.txt

ci-test:
	$(PYTEST) --cov=. --cov-report=xml --cov-fail-under=80 --junitxml=junit.xml

ci-lint:
	$(FLAKE8) . --count --select=E9,F63,F7,F82 --show-source --statistics
	$(BLACK) --check .
	$(ISORT) --check-only .

ci-security:
	$(BANDIT) -r . -f json -o bandit-report.json
	$(SAFETY) check --json --output safety-report.json

# Desenvolvimento
dev-setup: install-dev setup-db
	@echo "ğŸ‰ Ambiente de desenvolvimento configurado!"
	@echo "ğŸ“‹ PrÃ³ximos passos:"
	@echo "  1. Execute 'make run-dev' para iniciar o servidor"
	@echo "  2. Execute 'make test' para executar os testes"
	@echo "  3. Execute 'make help' para ver mais comandos"

# Comandos Ãºteis para desenvolvimento
test-specific:
	@echo "ğŸ§ª Execute um teste especÃ­fico:"
	@echo "Exemplo: pytest tests/test_models.py::TestUsuario::test_criar_usuario -v"

coverage-report:
	@echo "ğŸ“Š Gerando relatÃ³rio de cobertura..."
	$(COVERAGE) html
	@echo "RelatÃ³rio disponÃ­vel em htmlcov/index.html"

# Comandos para debug
debug-test:
	@echo "ğŸ› Executando testes em modo debug..."
	$(PYTEST) --pdb -x

debug-models:
	@echo "ğŸ› Testando apenas modelos..."
	$(PYTEST) tests/test_models.py -v --tb=long

# Performance
benchmark:
	@echo "âš¡ Executando testes de performance..."
	$(PYTEST) tests/test_integration.py::TestPerformance -v --benchmark-only

# UtilitÃ¡rios
requirements-update:
	@echo "ğŸ“¦ Atualizando requirements..."
	$(PIP) freeze > requirements.txt

create-migration:
	@echo "ğŸ—„ï¸ Comando para criar migraÃ§Ã£o (implementar com Flask-Migrate)"

# ValidaÃ§Ã£o completa antes de commit
pre-commit: format lint test-fast
	@echo "âœ… Pronto para commit!"

# ValidaÃ§Ã£o completa antes de push
pre-push: check-all test-coverage
	@echo "âœ… Pronto para push!"
